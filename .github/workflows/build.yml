name: Build BulletinPro with Nuitka

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka ordered-set zstandard
        pip install -r requirements.txt
    
    - name: Build with Nuitka
      run: |
        python -m nuitka `
          --standalone `
          --onefile `
          --enable-plugin=tk-inter `
          --windows-disable-console `
          --include-data-files=config.py=config.py `
          --output-dir=dist `
          --output-filename=BulletinPro.exe `
          --assume-yes-for-downloads `
          Page2.py
      shell: powershell
    
    - name: Test executable
      run: |
        if (Test-Path dist/BulletinPro.exe) {
          Write-Host "âœ… Executable created successfully"
          Get-Item dist/BulletinPro.exe | Select-Object Name, Length
        } else {
          Write-Host "âŒ Executable not found"
          exit 1
        }
      shell: powershell
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: BulletinPro-Windows
        path: dist/BulletinPro.exe
        retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          patchelf \
          ccache \
          python3-dev \
          libcairo2-dev \
          libpango1.0-dev \
          libgdk-pixbuf2.0-dev \
          libffi-dev \
          shared-mime-info \
          dpkg-dev \
          fakeroot
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka ordered-set zstandard
        pip install -r requirements.txt
    
    - name: Build with Nuitka
      run: |
        python -m nuitka \
          --standalone \
          --onefile \
          --enable-plugin=tk-inter \
          --include-data-files=config.py=config.py \
          --output-dir=dist \
          --output-filename=BulletinPro \
          --assume-yes-for-downloads \
          Page2.py
    
    - name: Test executable
      run: |
        if [ -f dist/BulletinPro ]; then
          echo "âœ… Executable created successfully"
          ls -lh dist/BulletinPro
          file dist/BulletinPro
        else
          echo "âŒ Executable not found"
          exit 1
        fi
    
    - name: Make executable
      run: chmod +x dist/BulletinPro
    
    - name: Create DEB package structure
      run: |
        # Variables
        VERSION="1.0.0"
        PACKAGE_NAME="bulletinpro"
        ARCH="amd64"
        
        # Create directories
        mkdir -p ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN
        mkdir -p ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/bin
        mkdir -p ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/applications
        mkdir -p ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/pixmaps
        mkdir -p ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/doc/${PACKAGE_NAME}
        
        # Copy executable
        cp dist/BulletinPro ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/bin/bulletinpro
        chmod 755 ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/bin/bulletinpro
        
        # Create control file
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/control << EOF
        Package: ${PACKAGE_NAME}
        Version: ${VERSION}
        Section: education
        Priority: optional
        Architecture: ${ARCH}
        Depends: libcairo2, libpango-1.0-0, libgdk-pixbuf2.0-0
        Maintainer: BulletinPro Team <contact@bulletinpro.com>
        Description: SystÃ¨me de gestion de bulletins scolaires
         BulletinPro est une application de gestion complÃ¨te pour les
         Ã©tablissements scolaires permettant de gÃ©nÃ©rer des bulletins
         de notes professionnels avec synchronisation cloud.
         .
         FonctionnalitÃ©s:
          - Gestion des Ã©lÃ¨ves, enseignants et classes
          - Saisie des notes et calcul automatique des moyennes
          - GÃ©nÃ©ration de bulletins PDF personnalisables
          - Synchronisation temps rÃ©el avec Supabase
          - Interface moderne et intuitive
        Homepage: https://github.com/Zelipro/Bulletin
        EOF
        
        # Create desktop entry
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/applications/bulletinpro.desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=BulletinPro
        Comment=Gestion de bulletins scolaires
        Exec=/usr/bin/bulletinpro
        Icon=bulletinpro
        Terminal=false
        Categories=Education;Office;
        Keywords=bulletin;notes;Ã©cole;Ã©lÃ¨ves;
        StartupNotify=true
        EOF
        
        # Create copyright file
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/doc/${PACKAGE_NAME}/copyright << EOF
        Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
        Upstream-Name: BulletinPro
        Upstream-Contact: contact@bulletinpro.com
        Source: https://github.com/Zelipro/Bulletin
        
        Files: *
        Copyright: 2024 BulletinPro Team
        License: Proprietary
        EOF
        
        # Create changelog
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian << EOF
        ${PACKAGE_NAME} (${VERSION}) stable; urgency=medium
        
          * Initial release
          * Gestion complÃ¨te des bulletins scolaires
          * Support multi-Ã©tablissements
          * Synchronisation cloud
        
         -- BulletinPro Team <contact@bulletinpro.com>  $(date -R)
        EOF
        gzip -9 ${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian
        
        # Create postinst script (exÃ©cutÃ© aprÃ¨s installation)
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        set -e
        
        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database -q
        fi
        
        echo "âœ… BulletinPro installÃ© avec succÃ¨s !"
        echo "Lancez l'application depuis le menu Applications ou avec : bulletinpro"
        
        exit 0
        EOF
        chmod 755 ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/postinst
        
        # Create prerm script (exÃ©cutÃ© avant dÃ©sinstallation)
        cat > ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/prerm << 'EOF'
        #!/bin/bash
        set -e
        
        echo "DÃ©sinstallation de BulletinPro..."
        
        exit 0
        EOF
        chmod 755 ${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/prerm
        
        # Build DEB package
        dpkg-deb --build ${PACKAGE_NAME}_${VERSION}_${ARCH}
        
        # Rename for clarity
        mv ${PACKAGE_NAME}_${VERSION}_${ARCH}.deb BulletinPro-${VERSION}-${ARCH}.deb
        
        # Show package info
        echo "ðŸ“¦ Package created:"
        ls -lh BulletinPro-${VERSION}-${ARCH}.deb
        dpkg-deb --info BulletinPro-${VERSION}-${ARCH}.deb
    
    - name: Upload Linux executable
      uses: actions/upload-artifact@v3
      with:
        name: BulletinPro-Linux
        path: dist/BulletinPro
        retention-days: 90
    
    - name: Upload DEB package
      uses: actions/upload-artifact@v3
      with:
        name: BulletinPro-DEB
        path: BulletinPro-*.deb
        retention-days: 90

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v3
      with:
        name: BulletinPro-Windows
        path: ./windows
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v3
      with:
        name: BulletinPro-Linux
        path: ./linux
    
    - name: Download DEB artifact
      uses: actions/download-artifact@v3
      with:
        name: BulletinPro-DEB
        path: ./deb
    
    - name: Create checksums
      run: |
        cd windows && sha256sum BulletinPro.exe > BulletinPro-Windows.sha256 && cd ..
        cd linux && sha256sum BulletinPro > BulletinPro-Linux.sha256 && cd ..
        cd deb && sha256sum *.deb > BulletinPro-DEB.sha256 && cd ..
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./windows/BulletinPro.exe
          ./windows/BulletinPro-Windows.sha256
          ./linux/BulletinPro
          ./linux/BulletinPro-Linux.sha256
          ./deb/*.deb
          ./deb/BulletinPro-DEB.sha256
        body: |
          ## ðŸŽ‰ BulletinPro v${{ github.ref_name }}
          
          ### ðŸ“¥ TÃ©lÃ©chargements
          
          **Windows** (.exe)
          - TÃ©lÃ©chargez `BulletinPro.exe`
          - Double-cliquez pour lancer
          - Aucune installation requise
          
          **Linux** (Binaire)
          - TÃ©lÃ©chargez `BulletinPro`
          - `chmod +x BulletinPro`
          - `./BulletinPro`
          
          **Ubuntu/Debian** (.deb)
          - TÃ©lÃ©chargez `BulletinPro-1.0.0-amd64.deb`
          - `sudo dpkg -i BulletinPro-1.0.0-amd64.deb`
          - Lancez depuis le menu Applications ou : `bulletinpro`
          
          ### âœ¨ NouveautÃ©s
          - PremiÃ¨re version stable
          - Gestion complÃ¨te des bulletins
          - Synchronisation cloud avec Supabase
          
          ### ðŸ”’ VÃ©rification (optionnel)
          VÃ©rifiez l'intÃ©gritÃ© des fichiers avec les checksums SHA256 fournis.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job optionnel : test des executables
  test-executables:
    needs: [build-windows, build-linux]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: ${{ matrix.os == 'windows-latest' && 'BulletinPro-Windows' || 'BulletinPro-Linux' }}
    
    - name: Test executable (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "Testing Windows executable..."
        if (Test-Path BulletinPro.exe) {
          Write-Host "âœ… File exists"
          $fileInfo = Get-Item BulletinPro.exe
          Write-Host "Size: $($fileInfo.Length / 1MB) MB"
        }
      shell: powershell
    
    - name: Test executable (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Testing Linux executable..."
        if [ -f BulletinPro ]; then
          echo "âœ… File exists"
          ls -lh BulletinPro
          file BulletinPro
        fi
